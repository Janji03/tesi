name: windows-msvc

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup CMake (pinned)
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "3.29.8"

      - name: Clone vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          git checkout 2024.05.24
          .\bootstrap-vcpkg.bat

      - name: Download ANTLR jar
        shell: pwsh
        run: |
          $jar = "antlr-4.13.2-complete.jar"
          $jarPath = Join-Path $env:GITHUB_WORKSPACE $jar
          Invoke-WebRequest -Uri "https://www.antlr.org/download/$jar" -OutFile $jarPath
          Write-Host "Downloaded $jarPath"

      - name: Configure (Debug, VS generator) + dump vcpkg logs on failure
        shell: pwsh
        run: |
          $jarPath = Join-Path $env:GITHUB_WORKSPACE "antlr-4.13.2-complete.jar"
          $toolchain = Join-Path $env:GITHUB_WORKSPACE "vcpkg\scripts\buildsystems\vcpkg.cmake"

          cmake -S toy-choreo -B build/ci-debug `
            -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DANTLR_JAR="$jarPath"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "===================="
            Write-Host "CMake configure failed. Dumping vcpkg logs..."
            Write-Host "===================="

            Write-Host "---- vcpkg issue_body.md (tail) ----"
            Get-Content -ErrorAction SilentlyContinue build/ci-debug/vcpkg_installed/vcpkg/issue_body.md -Tail 200

            Write-Host "---- antlr4 install-x64-windows-dbg-out.log (tail) ----"
            Get-Content -ErrorAction SilentlyContinue vcpkg/buildtrees/antlr4/install-x64-windows-dbg-out.log -Tail 200

            exit 1
          }

      - name: Build (Debug)
        shell: pwsh
        run: |
          cmake --build build/ci-debug --config Debug

      - name: Test (ctest)
        shell: pwsh
        run: |
          ctest --test-dir build/ci-debug -C Debug --output-on-failure

      - name: Upload vcpkg logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-logs
          path: |
            build/ci-debug/vcpkg_installed/vcpkg/issue_body.md
            vcpkg/buildtrees/antlr4/install-x64-windows-dbg-out.log
            build/ci-debug/vcpkg-manifest-install.log
          if-no-files-found: ignore
