name: windows-msvc

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Clone vcpkg
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          git checkout 2024.05.24
          .\bootstrap-vcpkg.bat

      - name: Download ANTLR jar
        shell: pwsh
        run: |
          $jar = "antlr-4.13.2-complete.jar"
          $jarPath = Join-Path $env:GITHUB_WORKSPACE $jar
          Invoke-WebRequest -Uri "https://www.antlr.org/download/$jar" -OutFile $jarPath
          Write-Host "Downloaded $jarPath"

      - name: Configure (Debug, VS generator)
        shell: pwsh
        run: |
          $jarPath = Join-Path $env:GITHUB_WORKSPACE "antlr-4.13.2-complete.jar"
          $toolchain = Join-Path $env:GITHUB_WORKSPACE "vcpkg\scripts\buildsystems\vcpkg.cmake"
          cmake -S toy-choreo -B build/ci-debug `
            -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DANTLR_JAR="$jarPath"

      - name: Build (Debug)
        shell: pwsh
        run: |
          cmake --build build/ci-debug --config Debug

      - name: Test (ctest)
        shell: pwsh
        run: |
          ctest --test-dir build/ci-debug -C Debug --output-on-failure
      - name: Dump vcpkg logs on failure
        if: failure()
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -ErrorAction SilentlyContinue vcpkg\buildtrees\antlr4 | Select-Object FullName
          Write-Host "---- install-x64-windows-dbg-out.log ----"
          Get-Content -ErrorAction SilentlyContinue vcpkg\buildtrees\antlr4\install-x64-windows-dbg-out.log -Tail 200
